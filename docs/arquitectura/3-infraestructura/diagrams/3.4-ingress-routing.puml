@startuml ingress-routing
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

title Ingress Architecture - Subdomain Routing

Person(user, "User", "Browser / API Client")

System_Boundary(external, "External Services") {
    Container(dns, "DNS Provider", "Route53 / Cloudflare", "*.dtwin.io â†’ Cluster LB")
    Container(certmanager, "Cert Manager", "Let's Encrypt", "Automatic SSL certificates")
}

System_Boundary(cluster, "Kubernetes Cluster") {
    
    Container(lb, "Cloud Load Balancer", "AWS ALB / Azure LB", "SSL termination\nDDoS protection")
    
    Container(ingress, "Ingress Controller", "Nginx", "Path & host routing\nRate limiting\nAuth headers")
    
    System_Boundary(ns_platform, "Namespace: dtwin-platform") {
        Container(frontend_svc, "Frontend Service", "ClusterIP", "Round-robin LB")
        Container(backend_svc, "Backend Service", "ClusterIP", "Round-robin LB")
        
        Container(frontend, "Frontend Pods", "Next.js:3000", "3 replicas\nVisual Editor")
        Container(backend, "Backend Pods", "FastAPI:8000", "3 replicas\nREST API")
    }
    
    System_Boundary(ns_workflows, "Namespace: dtwin-workflows") {
        Container(argo_svc, "Argo UI Service", "ClusterIP", "Workflow monitoring")
        Container(argo, "Argo Server", "Argo:2746", "Workflow dashboard")
    }
}

Rel(user, dns, "app.dtwin.io\napi.dtwin.io\nworkflows.dtwin.io", "DNS lookup")
Rel(dns, lb, "Resolves to LB IP", "A record")
Rel(lb, ingress, "Forwards traffic", "HTTPS")
Rel(certmanager, ingress, "Provisions certs", "TLS Secret")

Rel(ingress, frontend_svc, "Host: app.dtwin.io", "HTTP")
Rel(ingress, backend_svc, "Host: api.dtwin.io", "HTTP")
Rel(ingress, argo_svc, "Host: workflows.dtwin.io", "HTTP")

Rel(frontend_svc, frontend, "Port 3000", "TCP")
Rel(backend_svc, backend, "Port 8000", "TCP")
Rel(argo_svc, argo, "Port 2746", "TCP")

SHOW_LEGEND()
@enduml
