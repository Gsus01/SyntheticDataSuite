# 6.4. Empaquetado para Kubernetes

## Decisión de Diseño

Para gestionar los manifiestos de Kubernetes, la arquitectura contempla el uso de **Helm** como herramienta principal de empaquetado. Helm permite parametrizar los manifiestos, gestionar versiones de despliegue y reutilizar configuraciones entre entornos.

No obstante, **Kustomize** es una alternativa válida que puede complementar o sustituir a Helm según las preferencias del equipo. Ambas herramientas resuelven el mismo problema (gestión de variantes por entorno) con filosofías distintas.

---

## Comparativa

| Aspecto | Helm | Kustomize |
|:--------|:-----|:----------|
| **Enfoque** | Templating (Go templates) | Patching (overlays sobre base) |
| **Complejidad** | Mayor curva inicial | Más simple, YAML puro |
| **Parametrización** | `values.yaml` con tipado implícito | Patches y ConfigMapGenerators |
| **Versionado** | Chart con versión propia | Sin versionado inherente |
| **Ecosistema** | Repositorio de charts públicos | Integrado en `kubectl` |
| **Rollback** | Nativo (`helm rollback`) | Manual o vía GitOps |

---

## Recomendación Arquitectónica

Para una plataforma con múltiples servicios y entornos (dev, pre, prod), **Helm** ofrece ventajas en:

- **Gestión de releases**: cada despliegue queda registrado como una release con historial.
- **Valores por entorno**: un único chart con `values-dev.yaml`, `values-prod.yaml`.
- **Dependencias**: charts que dependen de otros (ej. backend depende de chart de PostgreSQL).

Sin embargo, si el equipo prefiere evitar templating y trabajar con YAML literal, Kustomize es una opción más ligera que no requiere herramientas adicionales.

---

## Estructura Propuesta (Helm)

```
deploy/
├── charts/
│   ├── platform/              # Chart paraguas (umbrella)
│   │   ├── Chart.yaml
│   │   ├── values.yaml        # Valores por defecto
│   │   └── templates/
│   │       └── ...
│   ├── backend/
│   │   ├── Chart.yaml
│   │   ├── values.yaml
│   │   └── templates/
│   │       ├── deployment.yaml
│   │       ├── service.yaml
│   │       └── ingress.yaml
│   └── frontend/
│       └── ...
└── environments/
    ├── dev/
    │   └── values.yaml        # Overrides para dev
    ├── pre/
    │   └── values.yaml
    └── prod/
        └── values.yaml
```

---

## Estado del Prototipo

El prototipo actual utiliza **manifiestos YAML planos** sin Helm ni Kustomize, almacenados en `deploy/k8s/`. Esta decisión simplifica la validación inicial evitando capas adicionales de tooling.

Para evolucionar hacia producción, se recomienda migrar a Helm cuando:
- Se necesite desplegar en múltiples entornos con configuraciones distintas.
- Se requiera historial de releases y capacidad de rollback.
- Se integre con herramientas GitOps como ArgoCD o Flux.

---

## Integración con GitOps

Independientemente de la herramienta elegida, el modelo GitOps propone que el repositorio de infraestructura sea la fuente de verdad. Un operador (ArgoCD, Flux) observa el repositorio y reconcilia el estado del clúster con lo declarado.

En este modelo:
- Los charts/overlays viven en el repositorio de infraestructura.
- La promoción entre entornos es un PR que modifica valores o referencias de imagen.
- El despliegue es automático tras aprobar el PR.
