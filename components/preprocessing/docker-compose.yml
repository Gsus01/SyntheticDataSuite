services:
  # Servicio principal para preprocesamiento de series temporales
  timeseries-preprocessor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ts-preprocessor
    volumes:
      - ./test_data/sensor_data_with_nulls.csv:/data/inputs/sensor_data_with_nulls.csv:ro
      - ./output:/data/outputs
      - ./config.yaml:/data/config/config.yaml:ro
    environment:
      - PYTHONUNBUFFERED=1
    user: "${UID:-1000}:${GID:-1000}"

  rul-batteries-preprocessor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rb-preprocessor
    volumes:
      - ./test_data/Battery_RUL.csv:/data/inputs/Battery_RUL.csv:ro
      - ./output:/data/outputs
      - ./config.yaml:/data/config/config.yaml:ro
    environment:
      - PYTHONUNBUFFERED=1
    user: "${UID:-1000}:${GID:-1000}"
    
  # Servicio para testing rápido con docker compose run --rm
  test-preprocessor:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./test_data/sensor_data_with_nulls.csv:/data/inputs/sensor_data_with_nulls.csv:ro
      - ./output:/data/outputs
      - ./config.yaml:/data/config/config.yaml:ro
    environment:
      - PYTHONUNBUFFERED=1
    user: "${UID:-1000}:${GID:-1000}"
    profiles:
      - test
  
  # Servicio para procesar datos de sensores
  process-sensors:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./test_data/sensor_data_with_nulls.csv:/data/inputs/sensor_data_with_nulls.csv:ro
      - ./output:/data/outputs
      - ./config.yaml:/data/config/config.yaml:ro
    environment:
      - PYTHONUNBUFFERED=1
    user: "${UID:-1000}:${GID:-1000}"
    profiles:
      - sensors
  
  # Servicio para procesar datos financieros
  process-financial:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./test_data/financial_data_with_outliers.csv:/data/inputs/financial_data_with_outliers.csv:ro
      - ./output:/data/outputs
      - ./config.yaml:/data/config/config.yaml:ro
    environment:
      - PYTHONUNBUFFERED=1
    user: "${UID:-1000}:${GID:-1000}"
    profiles:
      - financial
    
  # Servicio para procesar datos con timestamps irregulares
  process-irregular:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./test_data/irregular_timestamp_data.csv:/data/inputs/irregular_timestamp_data.csv:ro
      - ./output:/data/outputs
      - ./config.yaml:/data/config/config.yaml:ro
    environment:
      - PYTHONUNBUFFERED=1
    user: "${UID:-1000}:${GID:-1000}"
    profiles:
      - irregular
    
  # Servicio para procesar datos de tipos mixtos
  process-mixed:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./test_data/mixed_data_types.csv:/data/inputs/mixed_data_types.csv:ro
      - ./output:/data/outputs
      - ./config.yaml:/data/config/config.yaml:ro
    environment:
      - PYTHONUNBUFFERED=1
    user: "${UID:-1000}:${GID:-1000}"
    profiles:
      - mixed

  # Servicio para procesar múltiples archivos en paralelo (batch)
  batch-processor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ts-batch-processor
    volumes:
      - ./test_data/financial_data_with_outliers.csv:/data/inputs/financial_data_with_outliers.csv:ro
      - ./output:/data/outputs
      - ./batch_config.yaml:/data/config/config.yaml:ro
    environment:
      - PYTHONUNBUFFERED=1
    user: "${UID:-1000}:${GID:-1000}"
    profiles:
      - batch

  # Service for Black-Box testing
  # This service is intentionally minimal; command and specific
  # output/custom_config volumes are specified in the 'docker compose run' call
  # from the test script (test_container_execution.py)
  blackbox-test-runner:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - PYTHONUNBUFFERED=1
    user: "${UID:-1000}:${GID:-1000}"
    # Standard mount for input test data
    # ./test_data on host maps to /data/inputs in container
    # Standard mount for default config
    # ./config.yaml on host maps to /data/config/config.yaml in container
    # Note: The test scripts will dynamically add mounts for output directories
    # and custom configuration files using 'docker compose run -v ...'
    volumes:
      - ./test_data:/data/inputs:ro
      - ./config.yaml:/data/config/config.yaml:ro
      # The test_container_execution.py script will add:
      # -v <host_temp_output_dir>:/data/outputs
      # -v <host_temp_custom_config_dir>:/data/config/custom (for custom config tests)
